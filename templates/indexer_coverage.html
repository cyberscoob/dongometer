<!DOCTYPE html>
<html>
<head>
    <title>Indexer Coverage - CClub Matrix Archive</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            background: #0a0a0f; 
            color: #0f0; 
            padding: 20px;
            margin: 0;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #0f0; text-shadow: 0 0 10px #0f0; margin-bottom: 10px; }
        .subtitle { color: #666; margin-bottom: 30px; }
        
        .timeline-container {
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .room-timeline {
            margin: 15px 0;
            padding: 10px 0;
            border-bottom: 1px solid #222;
        }
        
        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .room-name { 
            color: #0ff; 
            font-weight: bold;
            font-size: 14px;
        }
        
        .room-stats {
            color: #888;
            font-size: 12px;
        }
        
        .timeline-bar {
            position: relative;
            height: 30px;
            background: #000;
            border: 1px solid #333;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .timeline-segment {
            position: absolute;
            height: 100%;
            top: 0;
        }
        
        .timeline-segment.data {
            background: linear-gradient(180deg, #0f0 0%, #0a0 100%);
            box-shadow: 0 0 5px #0f0;
        }
        
        .timeline-segment.gap {
            background: #1a0000;
            border: 1px solid #300;
        }
        
        .timeline-segment.recent {
            background: linear-gradient(180deg, #ff0 0%, #aa0 100%);
            box-shadow: 0 0 8px #ff0;
        }
        
        .timeline-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 10px;
            color: #666;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            padding: 15px;
            background: #111;
            border-radius: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        
        .legend-box.data { background: #0f0; box-shadow: 0 0 5px #0f0; }
        .legend-box.gap { background: #1a0000; border: 1px solid #300; }
        .legend-box.recent { background: #ff0; box-shadow: 0 0 5px #ff0; }
        
        .nav-link {
            display: inline-block;
            margin: 20px 0;
            padding: 10px 20px;
            background: #0f0;
            color: #000;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .nav-link:hover {
            background: #0ff;
            box-shadow: 0 0 20px #0ff;
        }
        
        .zoom-controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .zoom-btn {
            padding: 8px 15px;
            background: #222;
            border: 1px solid #0f0;
            color: #0f0;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .zoom-btn:hover {
            background: #0f0;
            color: #000;
        }
        
        .gap-info {
            position: absolute;
            background: rgba(50, 0, 0, 0.9);
            border: 1px solid #f00;
            color: #f88;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 11px;
            pointer-events: none;
            z-index: 100;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“Š Indexer Coverage Timeline</h1>
        <p class="subtitle">Visualizing data gaps and backfill progress across CClub Matrix rooms</p>
        
        <a href="/" class="nav-link">â¬… Dashboard</a>
        <a href="/indexer" class="nav-link">ðŸ“ˆ Activity Stats</a>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-box data"></div>
                <span>Events Indexed</span>
            </div>
            <div class="legend-item">
                <div class="legend-box gap"></div>
                <span>Data Gap (Need Backfill)</span>
            </div>
            <div class="legend-item">
                <div class="legend-box recent"></div>
                <span>Recent Activity (24h)</span>
            </div>
        </div>
        
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="setZoom('all')">All Time</button>
            <button class="zoom-btn" onclick="setZoom('year')">Last Year</button>
            <button class="zoom-btn" onclick="setZoom('month')">Last Month</button>
            <button class="zoom-btn" onclick="setZoom('week')">Last Week</button>
            <span id="zoom-label" style="margin-left: 20px; color: #888;">Showing: All Time</span>
        </div>
        
        <div class="timeline-container" id="timeline-container">
            <div style="text-align: center; padding: 50px; color: #666;">Loading timeline data...</div>
        </div>
        
        <div class="gap-info" id="gap-tooltip"></div>
    </div>

    <script>
        let currentZoom = 'all';
        let timelineData = null;
        
        const channelNames = {
            '!pYoawuzxaFxYhOVtjN:cclub.cs.wmich.edu': 'The Grand Hall',
            '!RfkQkxlYocxeqmrBXI:cclub.cs.wmich.edu': 'The Laboratory',
            '!SASTdXhcIphYEpMGty:cclub.cs.wmich.edu': 'The Observatory',
            '!xrWBUUXQVKbWIuvMDi:cclub.cs.wmich.edu': 'The Workshop',
            '!CUqbYAuoIkIOvzXnCA:cclub.cs.wmich.edu': 'The Archives',
            '!EjjqonNwfCfQEvxjmG:cclub.cs.wmich.edu': 'The Commons',
            '!ngdIUcFszKkRsppRwp:cclub.cs.wmich.edu': 'The Atrium',
            '!kMHDOGXKJmQizYEDTM:cclub.cs.wmich.edu': 'The Council Room',
            '!FuKVmsdGDqELoLzabM:cclub.cs.wmich.edu': 'The Vault',
            '!dkaEtUvJgNFDmbmfPL:cclub.cs.wmich.edu': 'The Study'
        };
        
        async function loadTimelineData() {
            try {
                const response = await fetch('/api/indexer-coverage');
                timelineData = await response.json();
                renderTimeline();
            } catch (err) {
                console.error('Failed to load:', err);
                document.getElementById('timeline-container').innerHTML = 
                    '<div style="text-align: center; padding: 50px; color: #f00;">Failed to load timeline data</div>';
            }
        }
        
        function setZoom(zoom) {
            currentZoom = zoom;
            const labels = { all: 'All Time', year: 'Last Year', month: 'Last Month', week: 'Last Week' };
            document.getElementById('zoom-label').textContent = 'Showing: ' + labels[zoom];
            renderTimeline();
        }
        
        function renderTimeline() {
            if (!timelineData) return;
            
            const container = document.getElementById('timeline-container');
            let minTime, maxTime;
            
            const now = Date.now();
            switch(currentZoom) {
                case 'week': minTime = now - 7 * 24 * 60 * 60 * 1000; break;
                case 'month': minTime = now - 30 * 24 * 60 * 60 * 1000; break;
                case 'year': minTime = now - 365 * 24 * 60 * 60 * 1000; break;
                default: minTime = timelineData.global_start;
            }
            maxTime = now;
            
            const timeRange = maxTime - minTime;
            
            let html = '';
            timelineData.rooms.forEach(room => {
                const fakeName = channelNames[room.room_id] || 'Channel ' + room.room_id.substring(0, 8);
                const totalDuration = room.last_event - room.first_event;
                const coverage = ((totalDuration / timeRange) * 100).toFixed(1);
                
                html += `<div class="room-timeline">
                    <div class="room-header">
                        <span class="room-name">${fakeName}</span>
                        <span class="room-stats">${room.event_count.toLocaleString()} events | ${coverage}% coverage</span>
                    </div>
                    <div class="timeline-bar" id="bar-${room.room_id.replace(/[^a-zA-Z0-9]/g, '')}">`;
                
                // Render segments
                room.segments.forEach(seg => {
                    if (seg.end < minTime || seg.start > maxTime) return;
                    
                    const start = Math.max(seg.start, minTime);
                    const end = Math.min(seg.end, maxTime);
                    const left = ((start - minTime) / timeRange) * 100;
                    const width = ((end - start) / timeRange) * 100;
                    
                    const isRecent = (now - end) < 24 * 60 * 60 * 1000;
                    const className = seg.has_data ? (isRecent ? 'recent' : 'data') : 'gap';
                    
                    html += `<div class="timeline-segment ${className}" 
                        style="left: ${left}%; width: ${width}%;"
                        title="${new Date(start).toLocaleString()} â†’ ${new Date(end).toLocaleString()}
${seg.has_data ? 'Events: ' + seg.count : 'GAP: No data'}"></div>`;
                });
                
                html += `</div>
                    <div class="timeline-labels">
                        <span>${new Date(minTime).toLocaleDateString()}</span>
                        <span>${new Date(maxTime).toLocaleDateString()}</span>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
        }
        
        loadTimelineData();
    </script>
</body>
</html>
